<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/base}"
  lang="id"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spring Boot Cash Flow</title>
  </head>

  <body>
    <div layout:fragment="content" class="mt-4">

      <!-- Header -->
      <div class="card shadow-sm border-0 mb-4" style="border-radius: 12px;">
        <div class="card-body d-flex justify-content-between align-items-center">
          <h3 class="m-0">
            ðŸ‘‹ Hay, <span class="fw-bold text-primary">[[${auth.name}]]</span>
          </h3>
          <a th:href="@{/auth/logout}" class="btn btn-danger btn-sm px-3">Keluar</a>
        </div>
      </div>

      <!-- Title + Button -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="m-0 fw-bold">Daftar Cash Flow</h4>
        <button class="btn btn-primary px-4"
                data-bs-toggle="modal"
                data-bs-target="#addCashFlowModal">
          + Tambah Cash Flow
        </button>
      </div>

      <!-- Table Card -->
      <div class="card shadow-sm border-0" style="border-radius: 12px;">
        <div class="card-body">

          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>No</th>
                <th>Tipe</th>
                <th>Sumber</th>
                <th>Label</th>
                <th>Jumlah</th>
                <th>Dibuat pada</th>
                <th>Tindakan</th>
              </tr>
            </thead>

            <tbody>
              <tr th:each="cashFlow, status : ${cashFlows}">
                <td th:text="${status.index + 1}"></td>

                <td>
                  <span th:if="${cashFlow.type == 'Inflow'}"
                        class="badge bg-success px-3 py-2">Pemasukan</span>
                  <span th:if="${cashFlow.type == 'Outflow'}"
                        class="badge bg-danger px-3 py-2">Pengeluaran</span>
                </td>

                <td th:text="${cashFlow.source}"></td>

                <td>
                  <span class="badge bg-secondary" style="font-size: 0.85rem;"
                        th:text="${cashFlow.label}"></span>
                </td>

                <td class="fw-bold"
                    th:text="${'Rp ' + #numbers.formatDecimal(cashFlow.amount, 0, 'COMMA', 0, 'POINT')}"></td>

                <td th:text="${#temporals.format(cashFlow.createdAt, 'd MMMM yyyy, HH:mm')}"></td>

                <td class="d-flex gap-1">
                  <a th:href="@{/cashflows/{cashFlowId}(cashFlowId=${cashFlow.id})}"
                     class="btn btn-info btn-sm text-white">
                    Detail
                  </a>

                  <button
                    th:id="|editCashFlowButton_${cashFlow.id}|"
                    th:attr="onclick=|prepareEditCashFlow(`${cashFlow.id}`, `${cashFlow.type}`, `${cashFlow.source}`, `${cashFlow.label}`, ${cashFlow.amount}, `${cashFlow.description}`)|"
                    class="btn btn-sm btn-warning">
                    Edit
                  </button>

                  <button
                    th:id="|deleteCashFlowButton_${cashFlow.id}|"
                    th:attr="onclick=|prepareDeleteCashFlow(`${cashFlow.id}`, `${cashFlow.source}`)|"
                    class="btn btn-sm btn-danger">
                    Hapus
                  </button>
                </td>
              </tr>

              <tr th:if="${#lists.isEmpty(cashFlows)}">
                <td colspan="7" class="text-center py-3">
                  Belum ada data cash flow.
                </td>
              </tr>
            </tbody>
          </table>

        </div>
      </div>

      <!-- Summary Section -->
      <div class="row mt-4">

        <div class="col-md-4">
          <div class="card bg-success text-white shadow-sm border-0" style="border-radius: 12px;">
            <div class="card-body">
              <h5>Total Pemasukan</h5>
              <h3 th:text="${'Rp ' + #numbers.formatDecimal(totalInflow, 0, 'COMMA', 0, 'POINT')}"></h3>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card bg-danger text-white shadow-sm border-0" style="border-radius: 12px;">
            <div class="card-body">
              <h5>Total Pengeluaran</h5>
              <h3 th:text="${'Rp ' + #numbers.formatDecimal(totalOutflow, 0, 'COMMA', 0, 'POINT')}"></h3>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card bg-primary text-white shadow-sm border-0" style="border-radius: 12px;">
            <div class="card-body">
              <h5>Saldo</h5>
              <h3 th:text="${'Rp ' + #numbers.formatDecimal(balance, 0, 'COMMA', 0, 'POINT')}"></h3>
            </div>
          </div>
        </div>

      </div>

      <!-- Include Modals -->
      <div th:replace="~{models/cashflows/add :: addCashFlowModal}"></div>
      <div th:replace="~{models/cashflows/edit :: editCashFlowModal}"></div>
      <div th:replace="~{models/cashflows/delete :: deleteCashFlowModal}"></div>

    </div>

    <!-- Scripts (TIDAK DIUBAH) -->
    <script layout:fragment="others-js">
      function prepareEditCashFlow(id, type, source, label, amount, description) {
        document.getElementById("editCashFlowId").value = id;
        document.getElementById("editCashFlowType").value = type;
        document.getElementById("editCashFlowSource").value = source;
        document.getElementById("editCashFlowLabel").value = label;
        document.getElementById("editCashFlowAmount").value = amount;
        document.getElementById("editCashFlowDescription").value = description;

        const editModal = new bootstrap.Modal(
          document.getElementById("editCashFlowModal")
        );
        editModal.show();
      }

      function prepareDeleteCashFlow(id, source) {
        document.getElementById("deleteCashFlowId").value = id;
        document.getElementById("deleteCashFlowSource").innerText = source;

        const deleteModal = new bootstrap.Modal(
          document.getElementById("deleteCashFlowModal")
        );
        deleteModal.show();
      }

      document.addEventListener("DOMContentLoaded", function () {
        if ("[[${addCashFlowModalOpen}]]" === "true") {
          new bootstrap.Modal(document.getElementById("addCashFlowModal")).show();
        }

        if ("[[${editCashFlowModalOpen}]]" === "true") {
          const id = "[[${editCashFlowModalId}]]";
          const btn = document.getElementById(`editCashFlowButton_${id}`);
          if (btn) btn.click();
        }

        if ("[[${deleteCashFlowModalOpen}]]" === "true") {
          const id = "[[${deleteCashFlowModalId}]]";
          const btn = document.getElementById(`deleteCashFlowButton_${id}`);
          if (btn) btn.click();
        }
      });
    </script>

  </body>
</html>
